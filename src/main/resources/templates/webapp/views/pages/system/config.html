<!DOCTYPE html>
<html lang="en" xmlns:th="https://www.thymeleaf.org">

<div th:replace="~{header :: stylesheets(title='Cấu hình hệ thống')}"></div>

<body class="hold-transition sidebar-mini layout-fixed">
    <div class="wrapper">
        <!-- Navbar (header) -->
        <div th:replace="~{header :: header}"></div>
        <!-- /.navbar (header)-->

        <!-- Main Sidebar Container -->
        <div th:replace="~{sidebar :: sidebar}"></div>

        <!-- Content Wrapper. Contains page content -->
        <div class="content-wrapper" style="padding-top: 10px; padding-bottom: 1px;">
            <!-- Main content -->
            <section class="content">
                <div class="container-fluid">
                    <!-- Small boxes (Stat box) -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <div class="row justify-content-between">
                                        <ul class="col-6 nav nav-pills">
                                            <li class="nav-item"><a class="nav-link text-bold active" href="#CONFIGURATION_TAB" id="configurationTabLbl" data-toggle="tab">Configuration</a></li>
                                            <li class="nav-item"><a class="nav-link text-bold" href="#SCHEDULE_TAB" id="scheduleTabLbl" data-toggle="tab">Schedule</a></li>
                                            <li class="nav-item"><a class="nav-link text-bold" href="#VOLUME_TAB" id="volumeTabLbl" data-toggle="tab">Volume</a></li>
                                        </ul>
                                        <div class="col-6 text-right">
                                            <button type="button" class="btn btn-sm btn-info" id="btnBackupData">Backup data</button>
                                            <button type="button" class="btn btn-sm btn-info" data-toggle="modal" data-target="#modalRestoreData">Restore data</button>
                                            <button type="button" class="btn btn-sm btn-info" data-toggle="modal" data-target="#modalCrawlerData">Crawler data</button>
                                            <button type="button" class="btn btn-sm btn-success" data-toggle="modal" data-target="#modalRefreshApp">Refresh app</button>
                                        </div>
                                        <div class="modal fade" id="modalRestoreData">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <strong class="modal-title">Do you want to restore data!</strong>
                                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <input class="form-control-sm" type="file" name="file" id="backupFileAttached"/>
                                                    </div>
                                                    <div class="modal-footer justify-content-end">
                                                        <button type="button" class="btn btn-default" data-dismiss="modal">No</button>
                                                        <button type="button" class="btn btn-primary" id="btnRestoreData">Yes</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="modal fade" id="modalCrawlerData">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <strong class="modal-title">Notification</strong>
                                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        Are you sure!
                                                    </div>
                                                    <div class="modal-footer justify-content-end">
                                                        <button type="button" class="btn btn-default" data-dismiss="modal">No</button>
                                                        <button type="button" class="btn btn-primary" id="btnCrawlerData">Yes</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="modal fade" id="modalRefreshApp">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <strong class="modal-title">Refresh app</strong>
                                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        1. Refresh category label <br>
                                                        2. ...
                                                    </div>
                                                    <div class="modal-footer justify-content-end">
                                                        <button type="button" class="btn btn-default" data-dismiss="modal">Hủy</button>
                                                        <button type="button" class="btn btn-primary" id="btnRefreshApp">Lưu</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body table-responsive p-0">
                                    <div class="tab-content">
                                        <div class="active tab-pane" id="CONFIGURATION_TAB">
                                            <div class="card-body p-0">
                                                <table class="table table-head-fixed table-bordered table-striped">
                                                    <thead>
                                                        <tr>
                                                            <th>STT</th>
                                                            <th>Name</th>
                                                            <th>Value</th>
                                                            <th>Sort</th>
                                                            <th>Thao tác</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="configurationTbl"></tbody>
                                                </table>
                                            </div>
                                            <div class="card-footer">
                                                <div th:replace="~{fragments :: pagination}"></div>
                                            </div>
                                        </div>

                                        <div class="tab-pane" id="SCHEDULE_TAB">
                                            <div class="card-body p-0">
                                                <table class="table table-head-fixed table-bordered table-striped">
                                                    <thead>
                                                        <tr>
                                                            <th>No.</th>
                                                            <th>Task ID</th>
                                                            <th>Task name</th>
                                                            <th>Execution Time</th>
                                                            <th>Last run</th>
                                                            <th>Note</th>
                                                            <th>Status</th>
                                                            <th></th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="scheduleTbl"></tbody>
                                                </table>
                                            </div>
                                        </div>

                                        <div class="tab-pane" id="VOLUME_TAB">
                                            <div class="card-body p-0">
                                                <table class="table table-head-fixed table-bordered table-striped">
                                                    <thead>
                                                        <tr>
                                                            <th>No.</th>
                                                            <th>Folder</th>
                                                            <th>Number of files</th>
                                                            <th>Used space (MB)</th>
                                                            <th>Notes</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="volumeTbl"></tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal fade" id="modalUpdate">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <strong class="modal-title">Cập nhật config</strong>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="row">
                                                    <div class="col-12">
                                                        <div class="form-group">
                                                            <label for="codeField">Code</label>
                                                            <input type="text" class="form-control" placeholder="Code" id="codeField" disabled>
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="nameField">Name</label>
                                                            <input type="text" class="form-control" placeholder="Name" id="nameField" disabled>
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="valueField">Value</label>
                                                            <input type="text" class="form-control" placeholder="Value" id="valueField">
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="sortField">Sort</label>
                                                            <input type="number" class="form-control" placeholder="0" id="sortField">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="modal-footer justify-content-end">
                                                <button type="button" class="btn btn-default" data-dismiss="modal">Hủy</button>
                                                <button type="button" class="btn btn-primary" id="btnUpdateSubmit">Lưu</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Control Sidebar -->
        <aside class="control-sidebar control-sidebar-dark">
            <!-- Control sidebar content goes here -->
        </aside>

        <div th:replace="~{header :: scripts}"></div>
    </div>

    <script type="text/javascript">
        let mvConfigs = [];
        let mvId;
        let mvCode = $("#codeField");
        let mvName = $("#nameField");
        let mvValue = $("#valueField");
        let mvSort = $("#sortField");

        $(document).ready(function() {
            createListener();
            loadConfigs();
            updateConfig();
            refreshApp();
            sendRequestBackupData();
            sendRequestRestoreData();
        });

        function createListener() {
            $("#btnCrawlerData").on("click", function () {
                crawlerData();
                $(this).prop('disabled', true);
                alert("System is crawling data.");
            });

            $("#configurationTabLbl").on("click", function () {
                loadConfigs();
            });

            $("#scheduleTabLbl").on("click", function () {
                loadSchedules();
            });

            $("#volumeTabLbl").on("click", function () {
                loadUsedSpace();
            });
        }

        function refreshApp() {
            $("#btnRefreshApp").on("click", function () {
                let apiURL = mvHostURLCallApi + '/sys/refresh';
                $.get(apiURL, function (response) {
                    if (response.status === "OK") {
                        alert(response.data);
                        window.location.reload();
                    }
                }).fail(function () {
                    showErrorModal("Could not connect to the server");
                });
            })
        }

        function updateConfig() {
            $(document).on("click", ".btn-update", function () {
                let config = mvConfigs[$(this).attr("configId")];
                mvId = config.id;
                mvCode.val(config.code);
                mvName.val(config.name);
                mvValue.val(config.value);
                mvSort.val(config.sort);
                $("#modalUpdate").modal();
            })

            $("#btnUpdateSubmit").on("click", function () {
                let apiURL = mvHostURLCallApi + "/sys/config/update/" + mvId;
                let body = {
                    id : mvId,
                    code : mvCode.val(),
                    name : mvName.val(),
                    value : mvValue.val(),
                    sort : mvSort.val()
                };
                $.ajax({
                    url: apiURL,
                    type: 'PUT',
                    contentType: "application/json",
                    data: JSON.stringify(body),
                    success: function(response) {
                        if (response.status === "OK") {
                            alert(response.message);
                            window.location.reload();
                        }
                    },
                    error: function(xhr, status, error) {
                        alert("Error: " + $.parseJSON(xhr.responseText).message);
                    }
                })
            })
        }

        function loadConfigs() {
            let apiURL = mvHostURLCallApi + '/sys/config/all';
            $.get(apiURL, function (response) {
                if (response.status === "OK") {
                    let data = response.data;
                    let contentTable = $('#configurationTbl');
                    contentTable.empty();
                    $.each(data, function (index, d) {
                        mvConfigs[d.id] = d;
                        contentTable.append(`
                            <tr>
                                <td>${index + 1}</td>
                                <td>${d.name}</td>
                                <td>${d.value}</td>
                                <td>${d.sort}</td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-info btn-update" configId="${d.id}"><i class="fa-solid fa-pencil"></i></button>
                                </td>
                            </tr>
                        `);
                    });
                }
            }).fail(function () {
                showErrorModal("Could not connect to the server");
            });
        }

        function crawlerData() {
            let apiURL = mvHostURLCallApi + '/sys/crawler-data';
            $.post(apiURL, function (response) {
                if (response.status === "OK") {
                    let message = response.message;
                    alert(message);
                    $("#btnCrawlerData").prop('disabled', false);
                }
            }).fail(function (xhr) {
                showErrorModal($.parseJSON(xhr.responseText).message);
            });
        }

        function sendRequestBackupData() {
            $('#btnBackupData').click(function () {
                // Disable button trong lúc chờ
                $('#btnBackupData').prop('disabled', true).text('Backing up...');

                $.ajax({
                    url: '/file/backup',
                    type: 'GET',
                    data: {},
                    xhrFields: {
                        responseType: 'blob' // để nhận file nhị phân
                    },
                    success: function (data, status, xhr) {
                        // Lấy tên file từ header nếu có
                        const disposition = xhr.getResponseHeader('Content-Disposition');
                        let filename = 'backup_' + new Date().toISOString().replace(/[:.]/g, '_') + '.zip';
                        if (disposition && disposition.indexOf('filename=') !== -1) {
                            filename = disposition.split('filename=')[1].replace(/"/g, '');
                        }

                        // Tạo link download tạm và kích hoạt
                        const url = window.URL.createObjectURL(data);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        a.remove();

                        alert('Backup completed successfully!');
                    },
                    error: function (xhr) {
                        const msg = xhr.responseJSON?.message || xhr.responseText || 'Backup failed';
                        alert('Error: ' + msg);
                    },
                    complete: function () {
                        $('#btnBackupData').prop('disabled', false).text('Backup data');
                    }
                });
            });
        }

        function sendRequestRestoreData() {
            $('#btnRestoreData').click(function () {
                const fileInput = $('#backupFileAttached')[0];
                if (fileInput.files.length === 0) {
                    alert('Please select a backup file to restore.');
                    return;
                }

                const file = fileInput.files[0];

                const formData = new FormData();
                formData.append('backupZip', file);

                // Gửi request POST tới backend
                $.ajax({
                    url: '/file/restore',
                    type: 'POST',
                    data: formData,
                    processData: false,  // Không xử lý data (vì là FormData)
                    contentType: false,  // Để browser tự set Content-Type: multipart/form-data
                    beforeSend: function () {
                        $('#btnRestoreData').prop('disabled', true).text('Restoring...');
                    },
                    success: function (response) {
                        alert(response);
                        $('#modalRestoreData').modal('hide');
                    },
                    error: function (xhr) {
                        const msg = xhr.responseJSON?.message || xhr.responseText || 'Restore failed';
                        alert('Error: ' + msg);
                    },
                    complete: function () {
                        $('#btnRestoreData').prop('disabled', false).text('Yes');
                        $('#backupFileAttached').val('');
                    }
                });
            });
        }

        function loadSchedules() {
            let apiURL = mvHostURLCallApi + "/sys/schedule";
            let params = {}
            $.get(apiURL, params, function (response) {
                if (response.status === "OK") {
                    let data = response.data;
                    let contentTable = $('#scheduleTbl');
                    contentTable.empty();
                    $.each(data, function (index, d) {
                        contentTable.append(`
                            <tr>
                                <td>${index + 1}</td>
                                <td>${d.taskId}</td>
                                <td>${d.taskName}</td>
                                <td>${d.executionTime}</td>
                                <td>${d.lastRun}</td>
                                <td>${d.note}</td>
                                <td>${d.status}</td>
                                <td></td>
                            </tr>
                        `);
                    });
                }
            }).fail(function () {
                showErrorModal("Could not connect to the server");
            });
        }

        function loadUsedSpace() {
            let apiURL = mvHostURLCallApi + "/sys/volume";
            let params = {}
            $.get(apiURL, params, function (response) {
                if (response.status === "OK") {
                    let data = response.data;
                    let contentTable = $('#volumeTbl');
                    contentTable.empty();
                    $.each(data, function (index, d) {
                        contentTable.append(`
                            <tr>
                                <td>${index + 1}</td>
                                <td>${d.folder}</td>
                                <td>${d.numberOfFiles}</td>
                                <td>${d.usedSpace}</td>
                                <td>${d.note}</td>
                            </tr>
                        `);
                    });
                }
            }).fail(function () {
                showErrorModal("Could not connect to the server");
            });
        }
    </script>
</body>
</html>